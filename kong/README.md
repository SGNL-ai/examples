# Kong API Gateway Plugin
This is a Kong API Gateway plugin implemented in LUA, which calls the SGNL access service API for performing authorization decisions for every request from an API client.


# Prerequisites

1. You have a SGNL environment up and running.
 
2. You have configured connectors to ingest data and have defined the appropriate relationship mappings.
 
3. You have created policy snippets and policy for evaluation.
 
4. You have created a protected application to test. You can use an Auth0 example such as the React single page application.
 
5. You will need Git to clone the example repository. You can follow the steps to install Git [here](https://github.com/git-guides/install-git).

6. Install Docker on your local environment.

7. You have a local [minikube](https://minikube.sigs.k8s.io/docs/) Kubernetes cluster.

8. You will need helm to deploy the Kong API Gateway. You may follow the installation instructions found [here](https://helm.sh/docs/intro/install/).

9. Ensure you have kubectl installed and you can manage the minikube cluster. Please visit [this guide](https://minikube.sigs.k8s.io/docs/handbook/kubectl/) to ensure you have a working kubectl configuration.

See our [Help Guides](https://help.sgnl.ai) for steps on configuring data sources and policies.


## Steps For Creating The Demo Environment


1. Clone the example repo using Git from https://github.com/SGNL-ai/examples.git.
2. Follow the minikube getting started [guide](https://minikube.sigs.k8s.io/docs/start/).
3. Once you have a minikube cluster you can start it by running ```minikube start```. **Note**: If you are using a Linux based system for this demo, please ensure Docker is started before starting minikube. You can run this command to start docker ```sudo systemctl start docker.service```. You will also need to ensure you are using the minikube Docker driver. See [this guide](https://minikube.sigs.k8s.io/docs/drivers/docker/) for starting minikube with the docker driver.
4. In a new terminal window, launch the minikube tunnel by running ``` minikube tunnel```.
5. In a new terminal window, launch the minikube dashboard by running ``` minikube dashboard```. This should launch your browser and land on the main Kubernetes dashboard page. Here you can easily view your deployments, Pods, Config Maps, Ingresses, etc. for your local Kubernetes cluster.
6. In order to install Kong, you will have to run the following commands:
   
   ```helm repo add kong https://charts.konghq.com```

   ```helm repo update```

   ```helm install kong/kong --generate-name -n kong --create-namespace```

7. Return to your minikube dashboard, select "Kong" from the namespace drop down list. You should see your Kong Ingress Controller listed in your deployments with a green status.
8. Now you are ready to install the sample echo service. Navigate under the yaml directory under the kong directory in your local SGNL Kong plugin sample git repository. Run the following commands:
   
    ```kubectl apply -f echo_svc.yaml ```

    ```kubectl apply -f ingress_class.yaml```

    ```kubectl apply -f ingress_routing.yaml```
9.  Update the entry for your local hosts file (usually located in /etc/hosts) with an entry that matches:
    ```127.0.0.1 kong.example```.
10. You can now make a curl request to the ingress route /echo by running ```curl -i http://kong.example/echo``` . If everything is set up ok, you should see a welcome message with the Pod and Namespace information. 
11. Now you are ready to create the Config Map containing the SGNL plugin example LUA source. Change directory one level up and do a directory listing. You should see a **"sgnl"** directory. **Note:** It is important to be at the correct level since the create ConfigMap command will require the sgnl directory contents (i.e. handler.lua,schema.lua). **Important:** You will need to replace the **{bearer token}** in the LUA source with the value generated by configuring your protected system in the SGNL user interface. For an example of configuring a protected system see, the [protecting a system with a SGNL SDK](https://help.sgnl.ai/articles/protected-systems/protected-system-sdk/) article.
12. Run the following command: ```kubectl create configmap sgnl-plugin --from-file=sgnl -n kong```. This command will create the config map that the Kong deployment uses to load the sample SGNL plugin.
13. Now you will need to change your deployment configuration to load the SGNL sample plugin. Switch to the "yaml" directory and run the following command: ```helm list -n kong```. Copy the name of the deployment. It may look like "kong-1693685226".
14. Now run the command to update the deployment using helm: ```helm upgrade {deployment name} kong/kong -f values.yaml -n kong```. **Note:** This will restart your kong pods. Please ensure they are back in a running state.
15. Once you have upgraded the deployment configuration, you can use the minikube dashboard to inspect the kong deployment configuration. In particular, you should see a "kong-plugin-sgnlplugin" volume configured to use the config map you created. You can also search for a deployment environment variable called "KONG_PLUGINS". You should see the following value: **"bundled,sgnlplugin"**.
16. Now you are ready to create the plugin resource and annotate the echo service so it can be protected by the SGNL plugin sample. To create the plugin resource, ensure you are under the yaml directory and run: ```kubectl apply -f plugin_resource.yaml -n kong```.
17. Now annotate the echo service by running: ```kubectl annotate service echo konghq.com/plugins=sgnlplugin -n kong```
18. The plugin is now enabled for just the echo service (/echo). You can run a test by running a curl command and sending a principal such as : ```curl -i -H"principal: {principalId}" http://kong.example/echo ```. If your principal is authorized to issue a GET request to the echo service, you will receive the service welcome message. If you are denied, you will receive an 403 status code, "SGNL Unauthorized" message.


## Congratulations
You have now run an SGNL authorization query from a Kong API Gateway plugin. By doing this, you are taking advantage of the power SGNL has to extend the Kong API Gateway with enterprise capabilities such as continuous access management, centralized policy management, audit, and reporting.



